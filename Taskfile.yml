version: "3"
silent: true
output: group

vars:
  # Default configurations
  RPC_URL: '{{.RPC_URL | default "http://127.0.0.1:8899"}}'

  # TALLY_PROGRAM_ID must be set - no fallbacks
  PROGRAM_ID:
    sh: |
      if [ -z "${TALLY_PROGRAM_ID}" ]; then
        echo "ERROR: TALLY_PROGRAM_ID environment variable is not set" >&2
        echo "Please export it in your shell or add to .env.local" >&2
        echo "Example: export TALLY_PROGRAM_ID=eUV3U3e6zdQRXmAJFrvEFF9qEdWvjnQMA9BRxJef4d7" >&2
        exit 1
      fi
      echo "${TALLY_PROGRAM_ID}"

  # Dynamic USDC_MINT from environment or .env.local
  USDC_MINT:
    sh: 'test -n "${USDC_MINT}" && echo "${USDC_MINT}" || { MINT=$(grep "USDC_MINT=" .env.local 2>/dev/null | tail -1 | cut -d"=" -f2); test -n "$MINT" && echo "$MINT" || echo ""; }'

  # Merchant PDA from .env.local
  MERCHANT_PDA:
    sh: 'grep "MERCHANT_PDA=" .env.local 2>/dev/null | tail -1 | cut -d"=" -f2 || echo ""'

  # Tool paths
  CARGO: '{{.CARGO | default "cargo"}}'
  SOLANA_CLI: '{{.SOLANA_CLI | default "solana"}}'

  # Binary name
  BIN_NAME: "tally-merchant"

  # Default output format
  OUTPUT_FORMAT: '{{.OUTPUT_FORMAT | default "human"}}'

dotenv: [".env.local", ".env"]

tasks:
  # =============================================================================
  # BUILD TASKS
  # =============================================================================

  build:
    desc: "Build CLI in debug mode"
    sources:
      - "src/**/*.rs"
      - "Cargo.toml"
      - "Cargo.lock"
    generates:
      - "target/debug/{{.BIN_NAME}}"
    cmds:
      - |
        echo "üî® Building tally-cli (debug)..."
        {{.CARGO}} build
        echo "‚úÖ CLI built successfully"

  build:release:
    desc: "Build CLI in release mode with optimizations"
    sources:
      - "src/**/*.rs"
      - "Cargo.toml"
      - "Cargo.lock"
    generates:
      - "target/release/{{.BIN_NAME}}"
    cmds:
      - |
        echo "üöÄ Building tally-cli (release)..."
        {{.CARGO}} build --release
        echo "‚úÖ Release build complete"

  install:
    desc: "Build in release mode and install to ~/.cargo/bin"
    cmds:
      - echo "üì¶ Installing {{.BIN_NAME}} to ~/.cargo/bin..."
      - '{{.CARGO}} install --path .'
      - echo "‚úÖ Installed successfully!"
      - echo "   Binary is in ~/.cargo/bin/{{.BIN_NAME}}"
      - echo "   Run with {{.BIN_NAME}} --help"

  build:check:
    desc: "Check compilation without building"
    cmds:
      - |
        echo "üîç Checking compilation..."
        {{.CARGO}} check
        echo "‚úÖ Compilation check passed"

  # =============================================================================
  # TESTING
  # =============================================================================

  test:
    desc: "Run all tests with cargo nextest (preferred)"
    deps: [build]
    cmds:
      - |
        echo "üß™ Running tests with nextest..."
        if command -v cargo-nextest >/dev/null 2>&1; then
          {{.CARGO}} nextest run
        else
          echo "‚ö†Ô∏è  cargo-nextest not found, using standard cargo test"
          echo "   Install with: cargo install cargo-nextest"
          {{.CARGO}} test
        fi
        echo "‚úÖ All tests passed"

  test:cargo:
    desc: "Run tests with standard cargo test"
    deps: [build]
    cmds:
      - |
        echo "üß™ Running tests with cargo test..."
        {{.CARGO}} test
        echo "‚úÖ All tests passed"

  test:unit:
    desc: "Run only unit tests"
    cmds:
      - |
        echo "üß™ Running unit tests..."
        {{.CARGO}} test --lib
        echo "‚úÖ Unit tests passed"

  test:integration:
    desc: "Run only integration tests"
    cmds:
      - |
        echo "üß™ Running integration tests..."
        {{.CARGO}} test --test '*'
        echo "‚úÖ Integration tests passed"

  test:watch:
    desc: "Run tests in watch mode (requires cargo-watch)"
    cmds:
      - |
        if ! command -v cargo-watch >/dev/null 2>&1; then
          echo "‚ùå cargo-watch not found"
          echo "   Install with: cargo install cargo-watch"
          exit 1
        fi
        echo "üëÄ Running tests in watch mode..."
        cargo watch -x test

  # =============================================================================
  # CODE QUALITY
  # =============================================================================

  lint:
    desc: "Run clippy lints (must pass with zero warnings)"
    cmds:
      - |
        echo "üîç Running clippy lints..."
        {{.CARGO}} clippy --all-targets --all-features -- -D warnings
        echo "‚úÖ Clippy checks passed"

  lint:fix:
    desc: "Auto-fix clippy issues"
    cmds:
      - |
        echo "üîß Auto-fixing clippy issues..."
        {{.CARGO}} clippy --all-targets --all-features --fix --allow-dirty --allow-staged
        echo "‚úÖ Clippy fixes applied"

  format:
    desc: "Format code with rustfmt"
    cmds:
      - |
        echo "üìê Formatting code..."
        {{.CARGO}} fmt --all
        echo "‚úÖ Code formatted"

  format:check:
    desc: "Check code formatting without modifying"
    cmds:
      - |
        echo "üìè Checking code formatting..."
        {{.CARGO}} fmt --all -- --check
        echo "‚úÖ Code formatting is correct"

  qa:
    desc: "Run full QA pipeline (format, lint, test)"
    cmds:
      - task: format:check
      - task: lint
      - task: test
      - echo "‚úÖ Full QA pipeline passed"

  qa:fix:
    desc: "Auto-fix all QA issues"
    cmds:
      - task: format
      - task: lint:fix
      - echo "‚úÖ QA fixes applied"

  # =============================================================================
  # ENVIRONMENT SETUP
  # =============================================================================

  env:check:
    desc: "Validate environment configuration"
    cmds:
      - |
        echo "üåç Checking environment configuration..."

        # Check TALLY_PROGRAM_ID
        if [ -z "${TALLY_PROGRAM_ID}" ]; then
          echo "‚ùå TALLY_PROGRAM_ID not set"
          echo "   Export it: export TALLY_PROGRAM_ID=<your-program-id>"
          exit 1
        fi
        echo "‚úÖ TALLY_PROGRAM_ID: ${TALLY_PROGRAM_ID}"

        # Check RPC connectivity
        if {{.SOLANA_CLI}} cluster-version --url {{.RPC_URL}} >/dev/null 2>&1; then
          echo "‚úÖ RPC accessible: {{.RPC_URL}}"
        else
          echo "‚ö†Ô∏è  RPC not accessible: {{.RPC_URL}}"
          echo "   Make sure validator is running for localnet"
        fi

        # Check wallet
        WALLET=$({{.SOLANA_CLI}} address 2>/dev/null || echo "")
        if [ -n "$WALLET" ]; then
          BALANCE=$({{.SOLANA_CLI}} balance --url {{.RPC_URL}} 2>/dev/null || echo "0")
          echo "‚úÖ Wallet: $WALLET"
          echo "‚úÖ Balance: $BALANCE"
        else
          echo "‚ö†Ô∏è  No wallet configured"
        fi

        # Check .env.local
        if [ -f .env.local ]; then
          echo "‚úÖ .env.local found"
          if [ -n "{{.USDC_MINT}}" ]; then
            echo "‚úÖ USDC_MINT: {{.USDC_MINT}}"
          else
            echo "‚ö†Ô∏è  USDC_MINT not set in .env.local"
          fi
          if [ -n "{{.MERCHANT_PDA}}" ]; then
            echo "‚úÖ MERCHANT_PDA: {{.MERCHANT_PDA}}"
          else
            echo "‚ö†Ô∏è  MERCHANT_PDA not set in .env.local"
          fi
        else
          echo "‚ö†Ô∏è  .env.local not found (will be created during setup)"
        fi

        echo ""
        echo "‚úÖ Environment check complete"

  env:show:
    desc: "Show current environment configuration"
    cmds:
      - |
        echo "üåç Current Environment Configuration:"
        echo ""
        echo "RPC_URL: {{.RPC_URL}}"
        echo "PROGRAM_ID: {{.PROGRAM_ID}}"
        echo "USDC_MINT: {{.USDC_MINT}}"
        echo "MERCHANT_PDA: {{.MERCHANT_PDA}}"
        echo "OUTPUT_FORMAT: {{.OUTPUT_FORMAT}}"
        echo ""
        echo "Wallet: $({{.SOLANA_CLI}} address 2>/dev/null || echo 'Not configured')"
        echo "Balance: $({{.SOLANA_CLI}} balance --url {{.RPC_URL}} 2>/dev/null || echo 'N/A')"

  env:create:
    desc: "Create .env.local template"
    status:
      - test -f .env.local
    cmds:
      - |
        echo "üìù Creating .env.local template..."
        cat > .env.local << 'EOF'
        # Tally CLI Environment Configuration

        # RPC endpoint (localnet, devnet, mainnet)
        RPC_URL=http://127.0.0.1:8899

        # Tally program ID (required)
        # Localnet: eUV3U3e6zdQRXmAJFrvEFF9qEdWvjnQMA9BRxJef4d7
        # Devnet: 6jsdZp5TovWbPGuXcKvnNaBZr1EBYwVTWXW1RhGa2JM5
        # TALLY_PROGRAM_ID=

        # USDC mint address (set by dev:usdc:setup)
        # USDC_MINT=

        # USDC associated token account (set by dev:usdc:setup)
        # USDC_ATA=

        # Merchant PDA (set by localnet:merchant:init)
        # MERCHANT_PDA=

        # Output format (human, json, csv)
        # OUTPUT_FORMAT=human
        EOF
        echo "‚úÖ .env.local template created"
        echo "   Edit this file to configure your environment"

  # =============================================================================
  # LOCALNET SETUP & TESTING
  # =============================================================================

  localnet:check:
    desc: "Check if localnet validator is running"
    cmds:
      - |
        echo "üîç Checking localnet validator..."
        if {{.SOLANA_CLI}} cluster-version --url {{.RPC_URL}} >/dev/null 2>&1; then
          SLOT=$({{.SOLANA_CLI}} slot --url {{.RPC_URL}})
          echo "‚úÖ Validator running (slot: $SLOT)"
        else
          echo "‚ùå Validator not running"
          echo "   Start it with: cd ../tally-platform && task dev:validator:start-bg"
          exit 1
        fi

  localnet:fund:
    desc: "Airdrop SOL to current wallet on localnet"
    deps: [localnet:check]
    cmds:
      - |
        echo "üí∞ Airdropping SOL to wallet..."
        WALLET=$({{.SOLANA_CLI}} address)
        {{.SOLANA_CLI}} airdrop 10 --url {{.RPC_URL}}
        BALANCE=$({{.SOLANA_CLI}} balance --url {{.RPC_URL}})
        echo "‚úÖ Wallet funded: $WALLET"
        echo "   Balance: $BALANCE"

  localnet:config:show:
    desc: "Show global program config on localnet"
    deps: [build, localnet:check]
    cmds:
      - |
        echo "üîç Showing program config on localnet..."
        {{.CARGO}} run -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          config show
        echo "‚úÖ Config displayed"

  localnet:merchant:init:
    desc: "Initialize merchant on localnet and save to .env.local"
    deps: [build, localnet:check]
    cmds:
      - |
        echo "üè™ Initializing merchant on localnet..."

        # Check for USDC_MINT
        if [ -z "{{.USDC_MINT}}" ]; then
          echo "‚ùå USDC_MINT not set in .env.local"
          echo "   Run: cd ../tally-platform && task dev:usdc:setup"
          exit 1
        fi

        # Read USDC_ATA
        USDC_ATA=$(grep "USDC_ATA=" .env.local 2>/dev/null | tail -1 | cut -d'=' -f2)
        if [ -z "$USDC_ATA" ]; then
          echo "‚ùå USDC_ATA not set in .env.local"
          echo "   Run: cd ../tally-platform && task dev:usdc:setup"
          exit 1
        fi

        # Initialize merchant
        OUTPUT=$({{.CARGO}} run -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          --usdc-mint {{.USDC_MINT}} \
          merchant init \
          --treasury "$USDC_ATA")

        echo "$OUTPUT"

        # Extract and save merchant PDA (look for "Merchant PDA:" line)
        MERCHANT_PDA=$(echo "$OUTPUT" | grep "Merchant PDA:" | awk '{print $3}')
        if [ -n "$MERCHANT_PDA" ]; then
          # Remove old MERCHANT_PDA if exists
          if [ -f .env.local ]; then
            grep -v "^MERCHANT_PDA=" .env.local > .env.local.tmp || true
            mv .env.local.tmp .env.local
          fi
          echo "MERCHANT_PDA=$MERCHANT_PDA" >> .env.local
          echo "‚úÖ Merchant initialized and saved to .env.local"
          echo "   PDA: $MERCHANT_PDA"
        else
          echo "‚ö†Ô∏è  Could not extract merchant PDA from output"
        fi

  localnet:plan:create:
    desc: "Create a subscription plan on localnet"
    deps: [build, localnet:check]
    cmds:
      - |
        echo "üìã Creating subscription plan on localnet..."

        # Validate environment
        if [ -z "{{.MERCHANT_PDA}}" ]; then
          echo "‚ùå MERCHANT_PDA not set in .env.local"
          echo "   Run: task localnet:merchant:init"
          exit 1
        fi

        if [ -z "{{.USDC_MINT}}" ]; then
          echo "‚ùå USDC_MINT not set in .env.local"
          exit 1
        fi

        # Plan parameters (can be overridden via env vars)
        PLAN_ID={{.PLAN_ID | default "basic"}}
        PLAN_NAME="{{.PLAN_NAME | default "Basic Plan"}}"
        PLAN_PRICE_USDC={{.PLAN_PRICE_USDC | default "5.0"}}
        PLAN_PERIOD_MONTHS={{.PLAN_PERIOD_MONTHS | default "1"}}
        PLAN_GRACE_DAYS={{.PLAN_GRACE_DAYS | default "5"}}

        echo "   Plan ID: $PLAN_ID"
        echo "   Name: $PLAN_NAME"
        echo "   Price: \$${PLAN_PRICE_USDC} USDC"
        echo "   Period: ${PLAN_PERIOD_MONTHS} month(s)"
        echo "   Grace: ${PLAN_GRACE_DAYS} day(s)"
        echo ""

        {{.CARGO}} run -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          --usdc-mint {{.USDC_MINT}} \
          plan create \
          --merchant {{.MERCHANT_PDA}} \
          --id "$PLAN_ID" \
          --name "$PLAN_NAME" \
          --price-usdc "$PLAN_PRICE_USDC" \
          --period-months "$PLAN_PERIOD_MONTHS" \
          --grace-days "$PLAN_GRACE_DAYS"

        echo "‚úÖ Plan created successfully"

  localnet:plans:list:
    desc: "List all plans for the merchant on localnet"
    deps: [build, localnet:check]
    cmds:
      - |
        echo "üìã Listing plans on localnet..."

        if [ -z "{{.MERCHANT_PDA}}" ]; then
          echo "‚ùå MERCHANT_PDA not set in .env.local"
          echo "   Run: task localnet:merchant:init"
          exit 1
        fi

        {{.CARGO}} run -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          --output {{.OUTPUT_FORMAT}} \
          plan list \
          --merchant {{.MERCHANT_PDA}}

  localnet:dashboard:
    desc: "Show dashboard overview for merchant on localnet"
    deps: [build, localnet:check]
    cmds:
      - |
        echo "üìä Dashboard Overview (localnet):"
        echo ""

        if [ -z "{{.MERCHANT_PDA}}" ]; then
          echo "‚ùå MERCHANT_PDA not set in .env.local"
          echo "   Run: task localnet:merchant:init"
          exit 1
        fi

        if [ -z "{{.USDC_MINT}}" ]; then
          echo "‚ùå USDC_MINT not set in .env.local"
          exit 1
        fi

        {{.CARGO}} run -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          --usdc-mint {{.USDC_MINT}} \
          dashboard overview \
          --merchant {{.MERCHANT_PDA}}

  localnet:setup:
    desc: "Complete localnet setup workflow (merchant init)"
    cmds:
      - task: env:check
      - task: localnet:check
      - task: localnet:fund
      - task: localnet:merchant:init
      - |
        echo ""
        echo "‚úÖ Localnet setup complete!"
        echo "   You can now create plans with: task localnet:plan:create"

  localnet:demo:
    desc: "Run complete demo workflow on localnet"
    cmds:
      - task: localnet:setup
      - task: localnet:plan:create
      - task: localnet:plans:list
      - task: localnet:dashboard
      - echo ""
      - echo "‚úÖ Demo complete!"

  # =============================================================================
  # END-TO-END TESTING
  # =============================================================================

  e2e:install:
    desc: "Build and install CLI for E2E testing"
    internal: true
    sources:
      - "src/**/*.rs"
      - "Cargo.toml"
      - "Cargo.lock"
    cmds:
      - |
        echo "üì¶ Installing tally-merchant to ~/.cargo/bin..."
        {{.CARGO}} install --path . --force
        echo "‚úÖ Installed successfully!"
        echo "   Binary: ~/.cargo/bin/tally-merchant"

  e2e:setup-wallet:
    desc: "Setup dedicated merchant dev wallet for E2E testing"
    internal: true
    cmds:
      - |
        WALLET_PATH="$HOME/.config/solana/merchant-dev.json"

        if [ ! -f "$WALLET_PATH" ]; then
          echo "üîë Creating merchant dev wallet..."
          mkdir -p "$(dirname "$WALLET_PATH")"
          solana-keygen new --no-bip39-passphrase --silent --outfile "$WALLET_PATH"
          echo "‚úÖ Wallet created: $WALLET_PATH"
        else
          echo "‚úÖ Wallet exists: $WALLET_PATH"
        fi

        WALLET_ADDR=$(solana-keygen pubkey "$WALLET_PATH")
        echo "   Address: $WALLET_ADDR"

  e2e:fund-wallet:
    desc: "Fund merchant dev wallet on localnet"
    internal: true
    cmds:
      - |
        WALLET_PATH="$HOME/.config/solana/merchant-dev.json"
        WALLET_ADDR=$(solana-keygen pubkey "$WALLET_PATH")

        echo "üí∞ Funding wallet..."

        # Check current balance
        BALANCE_STR=$({{.SOLANA_CLI}} balance "$WALLET_ADDR" --url {{.RPC_URL}} 2>/dev/null || echo "0 SOL")
        CURRENT_BALANCE=$(echo "$BALANCE_STR" | awk '{print int($1)}')

        if [ "$CURRENT_BALANCE" -lt 2 ]; then
          echo "   Attempting airdrop..."
          if {{.SOLANA_CLI}} airdrop 10 "$WALLET_ADDR" --url {{.RPC_URL}} 2>/dev/null; then
            echo "‚úÖ Airdrop successful"
            sleep 1
          else
            echo "‚ö†Ô∏è  Airdrop failed, transferring from main wallet..."
            MAIN_BALANCE=$({{.SOLANA_CLI}} balance --url {{.RPC_URL}} 2>/dev/null | awk '{print int($1)}')
            if [ "$MAIN_BALANCE" -lt 10 ]; then
              echo "‚ùå Main wallet has insufficient balance ($MAIN_BALANCE SOL)"
              echo "   Fund main wallet first: solana airdrop 100"
              exit 1
            fi

            MAX_RETRIES=3
            for i in $(seq 1 $MAX_RETRIES); do
              echo "   Transfer attempt $i/$MAX_RETRIES..."
              if {{.SOLANA_CLI}} transfer "$WALLET_ADDR" 10 \
                --url {{.RPC_URL}} \
                --allow-unfunded-recipient \
                --commitment confirmed 2>&1; then
                echo "‚úÖ Transfer successful"
                break
              elif [ $i -eq $MAX_RETRIES ]; then
                echo "‚ùå Failed to transfer after $MAX_RETRIES attempts"
                exit 1
              else
                echo "   Retrying in 2 seconds..."
                sleep 2
              fi
            done
          fi
        else
          echo "‚úÖ Wallet already funded (${CURRENT_BALANCE} SOL)"
        fi

        sleep 1
        BALANCE=$({{.SOLANA_CLI}} balance "$WALLET_ADDR" --url {{.RPC_URL}} 2>/dev/null || echo "0 SOL")
        echo "‚úÖ Final balance: $BALANCE"

  e2e:create-usdc-ata:
    desc: "Create USDC ATA for merchant dev wallet"
    internal: true
    vars:
      USDC_MINT:
        sh: 'grep "USDC_MINT=" .env.local 2>/dev/null | tail -1 | cut -d"=" -f2'
    cmds:
      - |
        WALLET_PATH="$HOME/.config/solana/merchant-dev.json"
        WALLET_ADDR=$(solana-keygen pubkey "$WALLET_PATH")

        if [ -z "{{.USDC_MINT}}" ]; then
          echo "‚ùå USDC_MINT not set in .env.local"
          echo "   Run: cd ../tally-platform && task dev:usdc:setup"
          exit 1
        fi

        echo "ü™ô Creating USDC ATA for merchant wallet..."

        OUTPUT=$(spl-token create-account {{.USDC_MINT}} --owner "$WALLET_ADDR" --fee-payer ~/.config/solana/id.json --url {{.RPC_URL}} 2>&1 || true)

        ATA=$(echo "$OUTPUT" | grep -oE '[1-9A-HJ-NP-Za-km-z]{32,44}' | head -1)

        if [ -z "$ATA" ]; then
          echo "‚ùå Failed to create/find ATA"
          echo "$OUTPUT"
          exit 1
        fi

        if echo "$OUTPUT" | grep -q "Creating account"; then
          echo "‚úÖ Created USDC ATA: $ATA"
        else
          echo "‚úÖ USDC ATA exists: $ATA"
        fi

        echo "$ATA" > /tmp/tally-merchant-dev-usdc-ata

  e2e:init-global-config:
    desc: "Initialize global program config"
    internal: true
    vars:
      USDC_MINT:
        sh: 'grep "USDC_MINT=" .env.local 2>/dev/null | tail -1 | cut -d"=" -f2'
    cmds:
      - |
        MAIN_WALLET="$HOME/.config/solana/id.json"
        PLATFORM_AUTHORITY=$(solana-keygen pubkey "$MAIN_WALLET")

        echo "‚öôÔ∏è  Initializing global program config..."
        echo "   Platform Authority: $PLATFORM_AUTHORITY"
        echo "   USDC Mint: {{.USDC_MINT}}"
        echo ""

        # Check if tally-admin exists
        if ! command -v tally-admin >/dev/null 2>&1; then
          echo "‚ö†Ô∏è  tally-admin not found, skipping global config initialization"
          echo "   Global config should already be initialized"
          exit 0
        fi

        # Check if config already exists (idempotent)
        if tally-admin --rpc-url {{.RPC_URL}} --program-id {{.PROGRAM_ID}} config view >/dev/null 2>&1; then
          echo "‚úÖ Global config already initialized"
        else
          tally-admin setup init \
            --rpc-url {{.RPC_URL}} \
            --program-id {{.PROGRAM_ID}} \
            --platform-authority "$PLATFORM_AUTHORITY" \
            --allowed-mint {{.USDC_MINT}} \
            --authority "$MAIN_WALLET"

          echo ""
          echo "‚úÖ Global config initialized successfully"
        fi

  e2e:init-payee:
    desc: "Initialize payee with merchant dev wallet"
    internal: true
    vars:
      USDC_MINT:
        sh: 'grep "USDC_MINT=" .env.local 2>/dev/null | tail -1 | cut -d"=" -f2'
    cmds:
      - |
        WALLET_PATH="$HOME/.config/solana/merchant-dev.json"
        export SOLANA_KEYPAIR="$WALLET_PATH"
        USDC_ATA=$(cat /tmp/tally-merchant-dev-usdc-ata)

        echo "üè™ Initializing payee with merchant dev wallet..."
        echo "   Wallet: $(solana-keygen pubkey "$WALLET_PATH")"
        echo "   Treasury: $USDC_ATA"
        echo ""

        # Check if payee already exists (idempotent)
        if [ -f /tmp/tally-merchant-dev-payee-pda ]; then
          EXISTING_PAYEE_PDA=$(cat /tmp/tally-merchant-dev-payee-pda)
          if cargo run --release -- \
            --rpc-url {{.RPC_URL}} \
            --program-id {{.PROGRAM_ID}} \
            --usdc-mint {{.USDC_MINT}} \
            payee show \
            --payee "$EXISTING_PAYEE_PDA" >/dev/null 2>&1; then
            echo "‚úÖ Payee already initialized"
            echo "   Payee PDA: $EXISTING_PAYEE_PDA"
            exit 0
          fi
        fi

        # Initialize new payee
        OUTPUT=$(cargo run --release -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          --usdc-mint {{.USDC_MINT}} \
          payee init \
          --authority "$WALLET_PATH" \
          --treasury "$USDC_ATA" 2>&1)

        echo "$OUTPUT"

        # Extract payee PDA
        PAYEE_PDA=$(echo "$OUTPUT" | grep "Payee PDA:" | awk '{print $3}')
        if [ -n "$PAYEE_PDA" ]; then
          echo "$PAYEE_PDA" > /tmp/tally-merchant-dev-payee-pda
          echo ""
          echo "‚úÖ Payee PDA: $PAYEE_PDA"
        else
          echo "‚ùå Failed to extract payee PDA"
          exit 1
        fi

  e2e:create-payment-terms:
    desc: "Create multiple payment terms for testing"
    internal: true
    vars:
      USDC_MINT:
        sh: 'grep "USDC_MINT=" .env.local 2>/dev/null | tail -1 | cut -d"=" -f2'
    cmds:
      - |
        WALLET_PATH="$HOME/.config/solana/merchant-dev.json"
        export SOLANA_KEYPAIR="$WALLET_PATH"
        PAYEE_PDA=$(cat /tmp/tally-merchant-dev-payee-pda)

        echo "üìã Creating test payment terms..."
        echo ""

        CREATED_COUNT=0
        SKIPPED_COUNT=0

        # Create Basic tier - $5/month
        echo "Creating: Basic ($5/month)..."
        if cargo run --release -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          --usdc-mint {{.USDC_MINT}} \
          payment-terms create \
          --authority "$WALLET_PATH" \
          --payee "$PAYEE_PDA" \
          --id "basic" \
          --amount-usdc "5.0" \
          --period-months "1" 2>&1 | grep -q "already exists"; then
          echo "‚úÖ Basic tier already exists"
          SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
        else
          CREATED_COUNT=$((CREATED_COUNT + 1))
        fi

        echo ""

        # Create Pro tier - $15/month
        echo "Creating: Pro ($15/month)..."
        if cargo run --release -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          --usdc-mint {{.USDC_MINT}} \
          payment-terms create \
          --authority "$WALLET_PATH" \
          --payee "$PAYEE_PDA" \
          --id "pro" \
          --amount-usdc "15.0" \
          --period-months "1" 2>&1 | grep -q "already exists"; then
          echo "‚úÖ Pro tier already exists"
          SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
        else
          CREATED_COUNT=$((CREATED_COUNT + 1))
        fi

        echo ""

        # Create Enterprise tier - $50/month
        echo "Creating: Enterprise ($50/month)..."
        if cargo run --release -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          --usdc-mint {{.USDC_MINT}} \
          payment-terms create \
          --authority "$WALLET_PATH" \
          --payee "$PAYEE_PDA" \
          --id "enterprise" \
          --amount-usdc "50.0" \
          --period-months "1" 2>&1 | grep -q "already exists"; then
          echo "‚úÖ Enterprise tier already exists"
          SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
        else
          CREATED_COUNT=$((CREATED_COUNT + 1))
        fi

        echo ""
        if [ $CREATED_COUNT -gt 0 ]; then
          echo "‚úÖ Created $CREATED_COUNT payment terms"
        fi
        if [ $SKIPPED_COUNT -gt 0 ]; then
          echo "‚úÖ Skipped $SKIPPED_COUNT existing payment terms"
        fi

  e2e:show-payee:
    desc: "Display payee details"
    internal: true
    vars:
      USDC_MINT:
        sh: 'grep "USDC_MINT=" .env.local 2>/dev/null | tail -1 | cut -d"=" -f2'
    cmds:
      - |
        WALLET_PATH="$HOME/.config/solana/merchant-dev.json"
        export SOLANA_KEYPAIR="$WALLET_PATH"
        PAYEE_PDA=$(cat /tmp/tally-merchant-dev-payee-pda)

        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "                    PAYEE DETAILS"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""

        cargo run --release -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          --usdc-mint {{.USDC_MINT}} \
          payee show \
          --payee "$PAYEE_PDA"

  e2e:list-payment-terms:
    desc: "List all payment terms"
    internal: true
    vars:
      USDC_MINT:
        sh: 'grep "USDC_MINT=" .env.local 2>/dev/null | tail -1 | cut -d"=" -f2'
    cmds:
      - |
        WALLET_PATH="$HOME/.config/solana/merchant-dev.json"
        export SOLANA_KEYPAIR="$WALLET_PATH"
        PAYEE_PDA=$(cat /tmp/tally-merchant-dev-payee-pda)

        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "                  PAYMENT TERMS"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""

        cargo run --release -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          --usdc-mint {{.USDC_MINT}} \
          payment-terms list \
          --payee "$PAYEE_PDA"

  e2e:dashboard:
    desc: "Show dashboard overview"
    internal: true
    vars:
      USDC_MINT:
        sh: 'grep "USDC_MINT=" .env.local 2>/dev/null | tail -1 | cut -d"=" -f2'
    cmds:
      - |
        WALLET_PATH="$HOME/.config/solana/merchant-dev.json"
        export SOLANA_KEYPAIR="$WALLET_PATH"
        PAYEE_PDA=$(cat /tmp/tally-merchant-dev-payee-pda)

        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "                    DASHBOARD"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""

        cargo run --release -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          --usdc-mint {{.USDC_MINT}} \
          dashboard overview \
          --merchant "$PAYEE_PDA"

  e2e:test-config:
    desc: "Test config file operations"
    internal: true
    cmds:
      - |
        WALLET_PATH="$HOME/.config/solana/merchant-dev.json"
        PAYEE_PDA=$(cat /tmp/tally-merchant-dev-payee-pda)

        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "               CONFIG FILE OPERATIONS"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""

        echo "üìù Testing config operations..."
        echo ""

        # Show current config
        echo "Current config:"
        cargo run --release -- config list || echo "No config yet"
        echo ""

        # Set merchant in profile
        echo "Setting merchant in config..."
        cargo run --release -- config set merchant "$PAYEE_PDA"
        echo ""

        # Show updated config
        echo "Updated config:"
        cargo run --release -- config list || echo "‚ö†Ô∏è  Config list currently unavailable"

        echo ""
        echo "‚úÖ Config operations complete"

  e2e:cleanup:
    desc: "Clean up E2E test state (keeps wallet, removes temp files)"
    cmds:
      - |
        echo "üßπ Cleaning up E2E test state..."
        rm -f /tmp/tally-merchant-dev-*
        echo "‚úÖ Cleanup complete"
        echo ""
        echo "Note: Wallet at ~/.config/solana/merchant-dev.json is preserved"
        echo "      To remove it: rm ~/.config/solana/merchant-dev.json"

  e2e:
    desc: "Run complete end-to-end test with merchant dev wallet"
    deps: [localnet:check, e2e:install]
    vars:
      USDC_MINT:
        sh: 'grep "USDC_MINT=" .env.local 2>/dev/null | tail -1 | cut -d"=" -f2'
    cmds:
      - |
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë          TALLY CLI END-TO-END TEST                        ‚ïë"
        echo "‚ïë          Using merchant-dev.json wallet                   ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
      - task: e2e:setup-wallet
      - task: e2e:fund-wallet
      - task: e2e:create-usdc-ata
      - task: e2e:init-global-config
      - task: e2e:init-payee
      - task: e2e:create-payment-terms
      - task: e2e:show-payee
      - task: e2e:list-payment-terms
      - task: e2e:dashboard
      - task: e2e:test-config
      - |
        echo ""
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë              E2E TEST COMPLETED SUCCESSFULLY              ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        echo "üìã Summary:"
        echo "   Wallet: $HOME/.config/solana/merchant-dev.json"
        echo "   Payee PDA: $(cat /tmp/tally-merchant-dev-payee-pda 2>/dev/null || echo 'N/A')"
        echo "   Payment Terms: 3 (basic, pro, enterprise)"
        echo ""
        echo "üéØ Next steps:"
        echo "   - Test agreements with a separate payer wallet"
        echo "   - Run: task e2e:cleanup to reset test state"

  # =============================================================================
  # CLI COMMANDS (Generic wrappers)
  # =============================================================================

  run:
    desc: "Run CLI with custom arguments (use -- to pass args)"
    deps: [build]
    cmds:
      - |
        {{.CARGO}} run -- \
          --rpc-url {{.RPC_URL}} \
          --program-id {{.PROGRAM_ID}} \
          {{.CLI_ARGS}}

  help:
    desc: "Show CLI help"
    deps: [build]
    cmds:
      - "{{.CARGO}} run -- --help"

  # =============================================================================
  # CLEANUP
  # =============================================================================

  clean:
    desc: "Clean build artifacts"
    cmds:
      - |
        echo "üßπ Cleaning build artifacts..."
        {{.CARGO}} clean
        echo "‚úÖ Clean complete"

  clean:env:
    desc: "Remove .env.local (warning: destructive)"
    cmds:
      - |
        if [ -f .env.local ]; then
          echo "‚ö†Ô∏è  Removing .env.local..."
          rm .env.local
          echo "‚úÖ .env.local removed"
        else
          echo "‚úÖ .env.local does not exist"
        fi

  # =============================================================================
  # UTILITIES
  # =============================================================================

  version:
    desc: "Show version information"
    cmds:
      - |
        echo "üìã Version Information:"
        echo "CLI: $({{.CARGO}} pkgid | cut -d'#' -f2)"
        echo "Rust: $({{.CARGO}} --version)"
        echo "Solana: $({{.SOLANA_CLI}} --version)"

  deps:install:
    desc: "Install required development dependencies"
    cmds:
      - |
        echo "üì¶ Installing development dependencies..."

        # Check and install cargo-nextest
        if ! command -v cargo-nextest >/dev/null 2>&1; then
          echo "Installing cargo-nextest..."
          {{.CARGO}} install cargo-nextest
        else
          echo "‚úÖ cargo-nextest already installed"
        fi

        # Check and install cargo-watch
        if ! command -v cargo-watch >/dev/null 2>&1; then
          echo "Installing cargo-watch..."
          {{.CARGO}} install cargo-watch
        else
          echo "‚úÖ cargo-watch already installed"
        fi

        echo "‚úÖ All dependencies installed"

  # =============================================================================
  # DEFAULT TASK
  # =============================================================================

  default:
    desc: "Show help and available tasks"
    cmds:
      - |
        echo "üéØ Tally CLI - Command Line Interface"
        echo "======================================"
        echo ""
      - task: version
      - task: env:show
      - |
        echo ""
        echo "üöÄ Quick Start (Localnet):"
        echo "  task localnet:setup    - Complete localnet setup"
        echo "  task localnet:demo     - Run full demo workflow"
        echo ""
        echo "üìã Common Tasks:"
        echo "  task build             - Build CLI in debug mode"
        echo "  task test              - Run all tests"
        echo "  task qa                - Run full QA pipeline"
        echo "  task env:check         - Validate environment"
        echo ""
        echo "üîß Localnet Operations:"
        echo "  task localnet:check           - Check validator status"
        echo "  task localnet:config:show     - Show program config"
        echo "  task localnet:merchant:init   - Initialize merchant"
        echo "  task localnet:plan:create     - Create subscription plan"
        echo "  task localnet:plans:list      - List all plans"
        echo "  task localnet:dashboard       - Show dashboard"
        echo ""
        echo "üìö For all tasks run: task --list"
